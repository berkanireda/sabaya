<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tableau de Bord • Location de Robes</title>

    <!-- Tailwind & Fonts -->
    <link rel="stylesheet" href="./output.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Appwrite SDK v11 -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>

    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-slate-50/80">

    <!-- Header -->
    <header id="header-placeholder" class="bg-white shadow-sm sticky top-0 z-40">
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-slate-900">Tableau de bord</h1>
            <p class="text-sm text-slate-500">Aperçu des performances de votre activité.</p>
        </div>

        <!-- Stats Cards -->
        <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- Squelette de chargement -->
            <div class="card-skeleton"></div>
            <div class="card-skeleton"></div>
            <div class="card-skeleton"></div>
        </div>

        <!-- Meilleures Robes -->
        <section class="mt-10">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold text-slate-900">Meilleures robes</h2>
                    <p class="text-xs text-slate-500">
                        Classement des robes par nombre de réservations et valeur générée.
                    </p>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th
                                    class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                    #</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                    Robe</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                    Nb réservations</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                    Prix d'achat</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                    Revenus</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                    ROI</th>
                            </tr>
                        </thead>
                        <tbody id="best-dresses-body" class="divide-y divide-slate-100">
                            <!-- Lignes ajoutées en JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- Template pour les cartes de stats -->
    <template id="stat-card-template">
        <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm flex items-start gap-4">
            <div class="stat-icon w-12 h-12 rounded-lg grid place-items-center text-xl">
                <i class="fa-solid"></i>
            </div>
            <div>
                <p class="stat-title text-sm font-medium text-slate-500"></p>
                <p class="stat-value text-3xl font-bold text-slate-800"></p>
            </div>
        </div>
    </template>

    <!-- Template pour le squelette de chargement -->
    <template id="skeleton-template">
        <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm flex items-start gap-4 animate-pulse">
            <div class="w-12 h-12 rounded-lg bg-slate-200"></div>
            <div class="flex-1 space-y-2">
                <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                <div class="h-8 bg-slate-200 rounded w-1/2"></div>
            </div>
        </div>
    </template>




    <script src="./js/auth.js"></script>

    <script>
        // === Appwrite Init ===



        function initPage() {

            // === UI Elements ===
            const userNameEl = document.getElementById('user-name');
            const userAvatarEl = document.getElementById('user-avatar');
            const logoutBtn = document.getElementById('logout-btn');
            const statsContainer = document.getElementById('stats-container');

            async function fetchAllDresses() {
                let allDresses = [];
                let lastId = null;

                while (true) {
                    const queries = [Appwrite.Query.limit(100)];
                    if (lastId) {
                        queries.push(Appwrite.Query.cursorAfter(lastId));
                    }
                    const response = await databases.listDocuments(DB_ID, COL_DRESSES, queries);
                    if (response.documents.length === 0) break;

                    allDresses.push(...response.documents);
                    lastId = response.documents[response.documents.length - 1].$id;
                }

                return allDresses;
            }


            // === Stats Calculation ===
            async function fetchAllBookings() {
                let allBookings = [];
                let lastId = null;
                while (true) {
                    const queries = [Appwrite.Query.limit(100)];
                    if (lastId) {
                        queries.push(Appwrite.Query.cursorAfter(lastId));
                    }
                    const response = await databases.listDocuments(DB_ID, COL_BOOKINGS, queries);
                    if (response.documents.length === 0) {
                        break;
                    }
                    allBookings.push(...response.documents);
                    lastId = response.documents[response.documents.length - 1].$id;
                }
                return allBookings;
            }

            function renderStatCard(icon, title, value, colorClass) {
                const template = document.getElementById('stat-card-template');
                const card = template.content.cloneNode(true).firstElementChild;
                card.querySelector('.stat-icon i').classList.add(icon);
                colorClass.split(' ').forEach(cls => card.querySelector('.stat-icon').classList.add(cls));
                card.querySelector('.stat-title').textContent = title;
                card.querySelector('.stat-value').textContent = value;
                return card;
            }


            // === Helpers de formatage ===
            const formatEuro = (number) => {
                if (!number) number = 0;
                return number.toLocaleString('fr-FR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }) + ' DA';
            };

            const formatInt = (number) => {
                if (!number) number = 0;
                return number.toLocaleString('fr-FR', {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                });
            };




            // === UI de la section "Meilleures robes" ===
            const bestDressesBody = document.getElementById('best-dresses-body');

            function computeBestDresses(bookings, dressesById = {}) {
                const map = new Map();

                for (const booking of bookings) {

                    const dressIds =
                        booking.dressIds || [];

                    if (!Array.isArray(dressIds) || dressIds.length === 0) continue;

                    // Si tu veux qu'une robe ne compte qu'UNE FOIS par réservation :
                    const uniqueDressIds = [...new Set(dressIds)];

                    uniqueDressIds.forEach((dressId) => {
                        if (!dressId) return;

                        // Infos depuis la collection "robes" si tu les as
                        const dressDoc = dressesById[dressId] || {};
                        const dressName =
                            dressDoc.name ||
                            `Robe_sans_nom ${dressId}`;

                        const purchasePrice =
                            dressDoc.purchase_price ||
                            0;

                        const dressPrice =
                            dressDoc.price ||
                            0;

                        if (!map.has(dressId)) {
                            map.set(dressId, {
                                id: dressId,
                                name: dressName,
                                purchase_price: purchasePrice,
                                nb_reservation: 0,
                                coutTotal: 0,
                                dress_price: dressPrice,
                            });
                        }

                        const entry = map.get(dressId);
                        entry.nb_reservation += 1;
                    });
                }

                // Calcul du produit nb_reservation * prix
                const result = Array.from(map.values()).map(dress => ({
                    ...dress,
                    coutTotal: dress.nb_reservation * (dress.purchase_price || 0),
                }));

                // Classement par nombre de réservations (desc)
                result.sort((a, b) => b.nb_reservation - a.nb_reservation);

                return result;
            }

            function renderBestDresses(dressesStats, maxRows = 10) {
                if (!bestDressesBody) return;

                bestDressesBody.innerHTML = '';

                if (!dressesStats || dressesStats.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">
                        Aucune donnée de réservation disponible pour le moment.
                    </td>
                `;
                    bestDressesBody.appendChild(tr);
                    return;
                }

                dressesStats.slice(0, maxRows).forEach((dress, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 transition-colors';

                    tr.innerHTML = `
                    <td class="px-4 py-3 text-xs text-slate-500">${index + 1}</td>
                    <td class="px-4 py-3 text-sm font-medium text-slate-800">${dress.name}</td>
                    <td class="px-4 py-3 text-sm text-slate-600 text-right">
                        ${formatInt(dress.nb_reservation)}
                    </td>
                    <td class="px-4 py-3 text-sm text-slate-600 text-right">
                        ${dress.purchase_price ? formatEuro(dress.purchase_price) : '-'}
                    </td>
                    <td class="px-4 py-3 text-sm font-semibold text-slate-900 text-right">
                        ${dress.nb_reservation ? formatEuro(dress.dress_price * dress.nb_reservation) : 0}
                    </td>

                    <td class="px-4 py-3 text-sm font-semibold text-slate-900 text-right">
                        ${dress.purchase_price ? formatInt((dress.dress_price * dress.nb_reservation) / dress.purchase_price) : 0}
                    </td>
                `;

                    bestDressesBody.appendChild(tr);
                });
            }





            async function displayStats() {
                // 1. Afficher les squelettes de chargement
                const skeletonTpl = document.getElementById('skeleton-template').content;
                statsContainer.innerHTML = '';
                statsContainer.append(skeletonTpl.cloneNode(true), skeletonTpl.cloneNode(true), skeletonTpl.cloneNode(true));

                // 2. Récupérer toutes les réservations + toutes les robes en parallèle
                const [bookings, dresses] = await Promise.all([
                    fetchAllBookings(),
                    fetchAllDresses()
                ]);

                const dressesById = {};
                for (const dress of dresses) {
                    dressesById[dress.$id] = dress;

                    // 3. Calculer les statistiques
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

                    let revenueToday = 0;
                    let revenueThisMonth = 0;
                    let bookingsThisMonth = 0;

                    for (const booking of bookings) {
                        // booking.date est une chaîne ISO (ex: "2025-11-14T10:30:00.000+00:00")
                        // On ne garde que la partie date (YYYY-MM-DD) pour une comparaison fiable
                        const bookingDateString = booking.date.substring(0, 10);
                        const todayDateString = today.toISOString().substring(0, 10);

                        // Chiffre d'affaires du jour
                        if (bookingDateString === todayDateString) {
                            revenueToday += booking.coutTotal || 0;
                        }

                        // Pour les stats du mois, la comparaison existante est correcte
                        const bookingDate = new Date(booking.date);
                        if (bookingDate >= startOfMonth) {
                            revenueThisMonth += booking.coutTotal || 0;
                            bookingsThisMonth++;
                        }
                    }

                    // 4. Afficher les cartes

                    statsContainer.innerHTML = ''; // Vider les squelettes

                    statsContainer.append(
                        renderStatCard('fa-sack-dollar', "Chiffre d'affaires du jour", formatEuro(revenueToday), 'bg-emerald-100 text-emerald-600'),
                        renderStatCard('fa-money-bill-trend-up', "Chiffre d'affaires (Mois)", formatEuro(revenueThisMonth), 'bg-blue-100 text-blue-600'),
                        renderStatCard('fa-calendar-plus', 'Nouvelles réservations (Mois)', formatInt(bookingsThisMonth), 'bg-amber-100 text-amber-600')
                    );

                    // 5. Meilleures robes
                    const bestDresses = computeBestDresses(bookings, dressesById);
                    renderBestDresses(bestDresses);
                }


            }

            // === Main Execution ===
            async function main() {
                await displayStats();
            }

            main();
        }
    </script>

</body>

</html>