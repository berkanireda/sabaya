<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tableau de Bord • Location de Robes</title>

    <!-- Tailwind & Fonts -->
    <link rel="stylesheet" href="./output.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Appwrite SDK v11 -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>

    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }


        .booking-card-transition {
            transition: opacity 0.5s ease-out, transform 0.5s ease-out, max-height 0.5s ease-out, padding 0.5s ease-out, margin 0.5s ease-out;
            overflow: hidden;
            /* Important pour cacher l'élément qui rétrécit */
            max-height: 200px;
            /* Taille maximale pour la transition (doit être supérieure à la taille réelle) */
        }

        .booking-card-removing {
            opacity: 0 !important;
            transform: translateY(-10px) !important;
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }
    </style>
</head>

<body class="bg-slate-50 h-screen w-full flex overflow-hidden">

    <aside id="sidebar-placeholder" class="w-64 h-full flex-shrink-0">
        <div class="h-full bg-white shadow-lg grid place-items-center">
            <i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i>
        </div>
    </aside>

    <div class="flex-1 h-full overflow-y-auto">
        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-slate-900">Tableau de bord</h1>
                <p class="text-sm text-slate-500">Aperçu des performances de votre activité.</p>
            </div>

            <!-- Stats Cards -->
            <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <!-- Squelette de chargement -->
                <div class="card-skeleton"></div>
                <div class="card-skeleton"></div>
                <div class="card-skeleton"></div>
            </div>


            <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col h-[300px]">
                    <div
                        class="p-5 border-b border-slate-100 flex items-center justify-between bg-blue-50/50 rounded-t-xl">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 grid place-items-center text-sm">
                                <i class="fa-solid fa-person-walking-luggage"></i>
                            </div>
                            Sorties d'aujourd'hui
                        </h3>
                        <span id="count-departures"
                            class="text-xs font-bold px-2 py-1 bg-white text-blue-600 rounded-md shadow-sm border border-blue-100">0</span>
                    </div>
                    <div id="departures-list" class="p-4 space-y-3 overflow-y-auto flex-1">
                        <p class="text-sm text-slate-400 text-center italic mt-10">Aucune sortie prévue aujourd'hui.</p>
                    </div>
                </div>

                <div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col h-[300px]">
                    <div
                        class="p-5 border-b border-slate-100 flex items-center justify-between bg-amber-50/50 rounded-t-xl">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <div
                                class="w-8 h-8 rounded-full bg-amber-100 text-amber-600 grid place-items-center text-sm">
                                <i class="fa-solid fa-rotate-left"></i>
                            </div>
                            Retours attendus (En cours)
                        </h3>
                        <span id="count-returns"
                            class="text-xs font-bold px-2 py-1 bg-white text-amber-600 rounded-md shadow-sm border border-amber-100">0</span>
                    </div>
                    <div id="returns-list" class="p-4 space-y-3 overflow-y-auto flex-1">
                        <p class="text-sm text-slate-400 text-center italic mt-10">Aucun retour en attente.</p>
                    </div>
                </div>

            </section>




            <!-- Meilleures Robes -->
            <section class="mt-10">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900">Meilleures robes</h2>
                        <p class="text-xs text-slate-500">
                            Classement des robes par nombre de réservations et valeur générée.
                        </p>
                    </div>
                </div>

                <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                        #</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                        Robe</th>
                                    <th
                                        class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                        Nb réservations</th>
                                    <th
                                        class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                        Prix d'achat</th>
                                    <th
                                        class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                        Revenus</th>
                                    <th
                                        class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                        ROI</th>
                                </tr>
                            </thead>
                            <tbody id="best-dresses-body" class="divide-y divide-slate-100">
                                <!-- Lignes ajoutées en JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Template pour les cartes de stats -->
    <template id="stat-card-template">
        <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm flex items-start gap-4">
            <div class="stat-icon w-12 h-12 rounded-lg grid place-items-center text-sm">
                <i class="fa-solid"></i>
            </div>
            <div>
                <p class="stat-title text-[13px] font-medium text-slate-500"></p>
                <p class="stat-value text-[18px] font-bold text-slate-800"></p>

                <p class="stat-sub-value1 hidden mt-1 text-xs text-slate-500"></p>
                <p class="stat-sub-value2 hidden mt-0.5 text-xs text-slate-500"></p>
            </div>
        </div>
    </template>

    <!-- Template pour le squelette de chargement -->
    <template id="skeleton-template">
        <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm flex items-start gap-4 animate-pulse">
            <div class="w-12 h-12 rounded-lg bg-slate-200"></div>
            <div class="flex-1 space-y-2">
                <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                <div class="h-8 bg-slate-200 rounded w-1/2"></div>
            </div>
        </div>
    </template>




    <script src="./js/auth.js"></script>

    <script>
        // === Appwrite Init ===

        // Helper pour les couleurs de statut


        function initPage() {

            // 1. Récupérer l'utilisateur
            const user = getCurrentUser();
            // === UI Elements ===
            const userNameEl = document.getElementById('user-name');
            const userAvatarEl = document.getElementById('user-avatar');
            const logoutBtn = document.getElementById('logout-btn');
            const statsContainer = document.getElementById('stats-container');
            // Références pour les listes de mouvements (déclarées dans le HTML)
            const depContainer = document.getElementById('departures-list');
            const retContainer = document.getElementById('returns-list');

            async function fetchAllDresses() {
                if (!user) return [];
                let allDresses = [];
                let lastId = null;

                while (true) {
                    const queries = [Query.limit(100), Query.equal("userId", [user.$id])];
                    if (lastId) {
                        queries.push(Query.cursorAfter(lastId));
                    }
                    const response = await databases.listDocuments(DB_ID, COL_DRESSES, queries);
                    if (response.documents.length === 0) break;

                    allDresses.push(...response.documents);
                    lastId = response.documents[response.documents.length - 1].$id;
                }

                return allDresses;
            }


            // === Stats Calculation ===
            async function fetchAllBookings() {
                let allBookings = [];
                let lastId = null;
                while (true) {
                    const queries = [Query.limit(100), Query.equal("userId", [user.$id])];
                    if (lastId) {
                        queries.push(Query.cursorAfter(lastId));
                    }
                    const response = await databases.listDocuments(DB_ID, COL_BOOKINGS, queries);
                    if (response.documents.length === 0) {
                        break;
                    }
                    allBookings.push(...response.documents);
                    lastId = response.documents[response.documents.length - 1].$id;
                }
                return allBookings;
            }

            function renderStatCard(icon, title, value, colorClass, subValue1 = null, subValue2 = null) {
                const template = document.getElementById('stat-card-template');
                const card = template.content.cloneNode(true).firstElementChild;
                card.querySelector('.stat-icon i').classList.add(icon);
                colorClass.split(' ').forEach(cls => card.querySelector('.stat-icon').classList.add(cls));
                card.querySelector('.stat-title').textContent = title;
                card.querySelector('.stat-value').textContent = value;

                // --- AJOUTS CI-DESSOUS ---
                const sub1 = card.querySelector('.stat-sub-value1');
                if (subValue1 && sub1) {
                    sub1.textContent = subValue1;
                    sub1.classList.remove('hidden');
                }

                const sub2 = card.querySelector('.stat-sub-value2');
                if (subValue2 && sub2) {
                    sub2.textContent = subValue2;
                    sub2.classList.remove('hidden');
                }
                // --- FIN DES AJOUTS ---

                return card;
            }

            function getStatusClass(status) {
                switch (status) {
                    case 'retiré': return 'bg-blue-100 text-blue-700 border-blue-200';
                    case 'rendu': return 'bg-emerald-100 text-emerald-700 border-emerald-200';
                    case 'annulé': return 'bg-red-100 text-red-700 border-red-200';
                    default: return 'bg-slate-100 text-slate-700 border-slate-200'; // en attente
                }
            }
            
            // ... (vos fonctions fetchAllDresses, fetchAllBookings, renderStatCard, formatEuro, formatInt, computeBestDresses, renderBestDresses sont ici) ...

            // --- NOUVEAU : Fonction de rendu des cartes AVEC SÉLECTEUR DE STATUT ---
        // --- NOUVEAU : Fonction de rendu des cartes AVEC SÉLECTEUR DE STATUT ---
            function renderBookingCard(booking, dressesById) {
                // Récupérer les noms des robes
                const dressNames = (booking.dressIds || [])
                    .map(id => dressesById[id]?.name || 'Robe inconnue')
                    .join(', ');
                
                const cost = booking.coutTotal || 0;
                const paid = booking.verse || 0;
                const remaining = cost - paid;
                const remainingClass = remaining > 0 ? 'text-red-600 font-semibold' : 'text-green-600';
                
                // Formatage date
                const dateStr = new Date(booking.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });

                const currentStatus = (booking.status || 'en attente').toLowerCase();
                const statusClass = getStatusClass(currentStatus);
                
                // data-booking-id est essentiel pour identifier la carte lors de l'événement 'change'
                return `
                <div class="booking-card-transition" data-booking-id="${booking.$id}" data-current-status="${currentStatus}">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start gap-3">
                            <div class="flex-grow">
                                
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-sm font-semibold text-slate-800">
                                        <i class="fas fa-tshirt text-slate-400 mr-1.5"></i>
                                        ${dressNames}
                                    </span>
                                </div>
                                
                                <div class="flex justify-between items-center text-xs text-slate-600 mb-2">
                                    <span>
                                        <i class="fa-solid fa-user text-slate-400 mr-1"></i> ${booking.clientName}
                                    </span>

                                    <select class="booking-status-select text-[11px] font-bold py-1 px-2 rounded-md border cursor-pointer outline-none transition-colors ${statusClass}" 
                                            data-booking-id="${booking.$id}" data-old-status="${currentStatus}">
                                        <option value="en attente" ${currentStatus === 'En attente' ? 'selected' : ''}>En attente</option>
                                        <option value="retiré" ${currentStatus === 'retiré' ? 'selected' : ''}>Retiré</option>
                                        <option value="rendu" ${currentStatus === 'rendu' ? 'selected' : ''}>Rendu</option>
                                        <option value="annulé" ${currentStatus === 'annulé' ? 'selected' : ''}>Annulé</option>
                                    </select>
                                </div>


                                <span class="text-[10px] font-medium bg-white border px-1.5 py-0.5 rounded text-slate-500">
                                    <i class="fa-solid fa-calendar-alt mr-1"></i> ${dateStr}
                                </span>


                                ${(cost > 0 || paid > 0) ? `
                                <div class="text-xs text-gray-700 mt-2 pt-2 border-t border-gray-200 flex justify-between">
                                    <span>${booking.voucherNumber ? `Bon: <strong>${booking.voucherNumber}</strong> | ` : ''} Coût: <strong>${formatEuro(cost)}</strong></span>
                                    <span class="${remainingClass}">Reste: ${formatEuro(remaining)}</span>
                                </div>` : ''}
                                
                                ${(booking.caution && booking.cautionMontant) ? `
                                <div class="text-[10px] text-amber-600 mt-1 flex items-center gap-1">
                                    <i class="fa-solid fa-triangle-exclamation"></i> Caution : ${formatEuro(booking.cautionMontant)}
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            // --- NOUVEAU : Gestionnaire de changement de statut avec animation ---
            async function handleStatusChangeDashboard(e) {
                if (!e.target.classList.contains('booking-status-select')) return;

                const selectEl = e.target;
                const bookingCard = selectEl.closest('.booking-card-transition');
                const bookingId = selectEl.dataset.bookingId;
                const newStatus = selectEl.value;
                const oldStatus = selectEl.dataset.oldStatus; // Ancien statut
                const currentContainerId = selectEl.closest('div[id$="-list"]').id;

                // 1. Mise à jour visuelle et désactivation
                selectEl.className = `booking-status-select text-[11px] font-bold py-1 px-2 rounded-md border cursor-pointer outline-none transition-colors ${getStatusClass(newStatus)}`;
                selectEl.disabled = true;

                try {
                    // 2. Sauvegarde Appwrite (Mise à jour du statut dans la BDD)
                    await databases.updateDocument(DB_ID, COL_BOOKINGS, bookingId, {
                        status: newStatus
                    });

                    // 3. Logique d'animation et de transition des listes
                    const isMovingOut = 
                        (currentContainerId === 'departures-list' && newStatus === 'retiré') || 
                        (currentContainerId === 'returns-list' && newStatus === 'rendu');

                    if (isMovingOut) {
                        // 3a. Lancer l'animation de disparition
                        bookingCard.classList.add('booking-card-removing');

                        // 3b. Attendre la fin de l'animation (0.5s)
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // 3c. Recharger TOUTES les statistiques pour recalculer les listes et les compteurs
                        await displayStats(); 

                    } else if (newStatus === 'annulé' || (oldStatus !== newStatus)) {
                         // Si on change de statut sans que la carte doive disparaître (ex: En attente -> Annulé)
                        // On recharge le tout pour que le statut soit affiché partout (et la carte disparaisse si elle ne doit plus être là)
                        await displayStats();
                    }

                } catch (error) {
                    console.error("Erreur mise à jour statut:", error);
                    alert("Impossible de changer le statut : " + error.message);
                } finally {
                    selectEl.disabled = false;
                }
            }
            // === Helpers de formatage ===
            const formatEuro = (number) => {
                if (!number) number = 0;
                return number.toLocaleString('fr-FR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }) + ' DA';
            };

            const formatInt = (number) => {
                if (!number) number = 0;
                return number.toLocaleString('fr-FR', {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                });
            };




            // === UI de la section "Meilleures robes" ===
            const bestDressesBody = document.getElementById('best-dresses-body');

            function computeBestDresses(bookings, dressesById = {}) {
                const map = new Map();

                for (const booking of bookings) {

                    const dressIds =
                        booking.dressIds || [];

                    if (!Array.isArray(dressIds) || dressIds.length === 0) continue;

                    // Si tu veux qu'une robe ne compte qu'UNE FOIS par réservation :
                    const uniqueDressIds = [...new Set(dressIds)];

                    uniqueDressIds.forEach((dressId) => {
                        if (!dressId) return;

                        // Infos depuis la collection "robes" si tu les as
                        const dressDoc = dressesById[dressId] || {};
                        const dressName =
                            dressDoc.name ||
                            `Robe_sans_nom ${dressId}`;

                        const purchasePrice =
                            dressDoc.purchase_price ||
                            0;

                        const dressPrice =
                            dressDoc.price ||
                            0;

                        if (!map.has(dressId)) {
                            map.set(dressId, {
                                id: dressId,
                                name: dressName,
                                purchase_price: purchasePrice,
                                nb_reservation: 0,
                                coutTotal: 0,
                                dress_price: dressPrice,
                            });
                        }

                        const entry = map.get(dressId);
                        entry.nb_reservation += 1;
                    });
                }

                // Calcul du produit nb_reservation * prix
                const result = Array.from(map.values()).map(dress => ({
                    ...dress,
                    coutTotal: dress.nb_reservation * (dress.purchase_price || 0),
                }));

                // Classement par nombre de réservations (desc)
                result.sort((a, b) => b.nb_reservation - a.nb_reservation);

                return result;
            }

            function renderBestDresses(dressesStats, maxRows = 10) {
                if (!bestDressesBody) return;

                bestDressesBody.innerHTML = '';

                if (!dressesStats || dressesStats.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">
                        Aucune donnée de réservation disponible pour le moment.
                    </td>
                `;
                    bestDressesBody.appendChild(tr);
                    return;
                }

                dressesStats.slice(0, maxRows).forEach((dress, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 transition-colors';

                    tr.innerHTML = `
                    <td class="px-4 py-3 text-xs text-slate-500">${index + 1}</td>
                    <td class="px-4 py-3 text-sm font-medium text-slate-800">${dress.name}</td>
                    <td class="px-4 py-3 text-sm text-slate-600 text-right">
                        ${formatInt(dress.nb_reservation)}
                    </td>
                    <td class="px-4 py-3 text-sm text-slate-600 text-right">
                        ${dress.purchase_price ? formatEuro(dress.purchase_price) : '-'}
                    </td>
                    <td class="px-4 py-3 text-sm font-semibold text-slate-900 text-right">
                        ${dress.nb_reservation ? formatEuro(dress.dress_price * dress.nb_reservation) : 0}
                    </td>

                    <td class="px-4 py-3 text-sm font-semibold text-slate-900 text-right">
                        ${dress.purchase_price ? formatInt((dress.dress_price * dress.nb_reservation) / dress.purchase_price) : 0}
                    </td>
                `;

                    bestDressesBody.appendChild(tr);
                });
            }


    
            async function displayStats() {
                // 1. Squelettes (Inchangé)
                const skeletonTpl = document.getElementById('skeleton-template').content;
                statsContainer.innerHTML = '';
                statsContainer.append(skeletonTpl.cloneNode(true), skeletonTpl.cloneNode(true), skeletonTpl.cloneNode(true));

                // 2. Fetch Data (Inchangé)
                const [bookings, dresses] = await Promise.all([
                    fetchAllBookings(),
                    fetchAllDresses()
                ]);

                // Map Robes (Inchangé)
                const dressesById = {};
                for (const dress of dresses) {
                    dressesById[dress.$id] = dress;
                }

                // 3. Calculs Stats (Inchangé)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

                let revenueToday = 0, revenueThisMonth = 0, bookingsThisMonth = 0, dueThisMonth = 0, verseThisMonth = 0;
                let verseToday = 0, cautionToday = 0;

                // === NOUVELLES LISTES POUR LE DASHBOARD ===
                const departuresList = []; // Sorties d'aujourd'hui
                const returnsList = [];    // Entrées (Commandes d'avant en statut 'retiré')

                for (const booking of bookings) {
                    const bookingDate = new Date(booking.date);
                    // Reset heure pour comparaison stricte de jour
                    const bookingDateMidnight = new Date(bookingDate);
                    bookingDateMidnight.setHours(0, 0, 0, 0);

                    const isToday = bookingDateMidnight.getTime() === today.getTime();
                    const isBeforeToday = bookingDateMidnight.getTime() < today.getTime();

                    // Statut (gestion du null ou undefined)
                    const status = booking.status || 'En attente';

                    // --- LOGIQUE STATS FINANCIERES (Inchangé) ---
                    if (isToday) {
                        revenueToday += booking.coutTotal || 0;
                        verseToday += booking.verse || 0;
                        if (booking.caution) cautionToday += booking.cautionMontant || 0;
                    }
                    if (bookingDate >= startOfMonth) {
                        revenueThisMonth += booking.coutTotal || 0;
                        bookingsThisMonth++;
                    }

                    if (bookingDate >= startOfMonth) {
                        verseThisMonth += booking.verse || 0;
                        bookingsThisMonth++;
                    }

                    if (bookingDate >= startOfMonth) {
                        dueThisMonth = revenueThisMonth - verseThisMonth || 0;
                    }

                    // --- NOUVELLE LOGIQUE : REMPLISSAGE DES LISTES ---

                    // 1. SORTIES : C'est aujourd'hui ET c'est "en attente" (pas encore retiré)
                    if (isToday && status === 'En attente') {
                        departuresList.push(booking);
                    }

                    // 2. ENTRÉES : C'était AVANT aujourd'hui ET c'est "retiré" (donc dehors)
                    if (isBeforeToday && status === 'retiré') {
                        returnsList.push(booking);
                    }
                }

                // 4. Affichage des Cartes Stats (Inchangé)
                statsContainer.innerHTML = '';
                statsContainer.append(
                    renderStatCard('fa-sack-dollar', "Chiffre d'affaires du jour", formatEuro(revenueToday), 'bg-emerald-100 text-emerald-600', `Versé: ${formatEuro(verseToday)}`, `Caution: ${formatEuro(cautionToday)}`),
                    renderStatCard('fa-money-bill-trend-up', "Chiffre d'affaires (Mois)", formatEuro(revenueThisMonth), 'bg-blue-100 text-blue-600', `Montant dû: ${formatEuro(dueThisMonth)}`),
                    renderStatCard('fa-calendar-plus', 'Nombre de réservations (Mois)', formatInt(bookingsThisMonth), 'bg-amber-100 text-amber-600')
                );

                // 5. Affichage Meilleures Robes (Inchangé)
                const bestDresses = computeBestDresses(bookings, dressesById);
                renderBestDresses(bestDresses);

                // 6. === NOUVEAU : AFFICHAGE DES MOUVEMENTS ===
                displayMovements(departuresList, returnsList, dressesById);
            }

            function displayMovements(departures, returns, dressesById) {
                // ... (code inchangé, utilise les fonctions ci-dessus) ...
                const depContainer = document.getElementById('departures-list');
                const retContainer = document.getElementById('returns-list');
                
                document.getElementById('count-departures').textContent = departures.length;
                document.getElementById('count-returns').textContent = returns.length;

                // Remplir Sorties
                if (departures.length === 0) {
                    depContainer.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-slate-400 italic"><i class="fa-solid fa-check-circle text-2xl mb-2 text-slate-200"></i>Aucune sortie en attente.</div>';
                } else {
                    depContainer.innerHTML = departures.map(b => renderBookingCard(b, dressesById)).join('');
                }

                // Remplir Entrées
                if (returns.length === 0) {
                    retContainer.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-slate-400 italic"><i class="fa-solid fa-check-circle text-2xl mb-2 text-slate-200"></i>Aucun retour en attente.</div>';
                } else {
                    retContainer.innerHTML = returns.map(b => renderBookingCard(b, dressesById)).join('');
                }
            }

          // === Main Execution == 

            async function main() {
                await displayStats();
            }



            const mainContentArea = document.querySelector('.flex-1.h-full.overflow-y-auto');
            if (mainContentArea) {
                 mainContentArea.addEventListener('change', handleStatusChangeDashboard);
            }
            main();

  
        }

    </script>

</body>

</html>